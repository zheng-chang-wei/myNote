

------
mysql 的调优大纲

1、慢查询的开启并捕获  （mysqldumpslow）
2、explain+慢SQL分析
3、show profile查询SQL在Mysql服务器里面的执行细节和生命周期情况
4、SQL数据库服务器的参数调优




## 1 表结构优化

字段类型应该要满足需求，尽量要满足以下需求。

尽可能小（占用存储空间少）、尽可能定长（占用存储空间固定）、尽可能使用整数。

### 1.1 列类型之数值
（1）整型
MySQL数据库支持五种整型类型，包括：TINYINT、SMALLINT、MEDIUMINT、INT和BIGINT五种。

整型类型占用空间和取值范围

类型      字节             最小值                               最大值

TINYINT     1   有符号：-128 无符号：0                    有符号：127 无符号：255

SMALLINT    2   有符号：-32768无符号：0                   有符号：32767无符号：65535

MEDIUMINT   3   有符号：-8388608无符号：0                 有符号：8388607无符号：16777215

INT/INTEGER 4   有符号：-2147483648无符号：0              有符号：2147483647无符号：4294967295  2^32-1

BIGINT      8   有符号：-9223372036854775808无符号：0     有符号：9223372036854775807无符号：18446744073709551615

五种整型的适用场景：

TINYINT，年龄，包含在0~255之间；

SMALLINT，端口号，包含在0~65535之间；

MEDIUMINT，中小型网站注册会员，1600万够用；

INT，身份证编号，42亿可以用很久；

BIGINT，Twitter微博量，几百亿

（2）浮点型(非精确)

MySQL数据库支持两种浮点类型：FLOAT(单精度)和DOUBLE(双精度)两种

浮点型(非精确)占用空间和取值范围

类型 字节 范围

FLOAT 4 正数范围：1.175494351E-38~3.402823466E+38，负数范围：-3.402823466E+38~-1.175494351E-38

DOUBLE 8 正数范围：1.7976931348623157E-308~2.2250738585072014E+308

负数范围：-2.2250738585072014E+308~-1.7976931348623157E-308

精度丢失
float例如：
1、money float  插入数据 money=1234567  结果money=1234570；插入数据money=12345.16 结果money=12345.2；结论float总长度为6位，超出部分四舍五入
2、money float(6,3) 6为总长度,3为小数部分长度； 
插入数据money=1234.123 报错因为整数部分长度超过6-3=3；整数部分长度可以小于m-n，不能大于m-n
插入数据money=123.1235 结果money=123.124
3、money float（8,0） money>16777216  2^24后精度丢失
4、money float（8,1） money>1048576  2^20后进度丢失 3*（8-1）-1=20
5、money float（8,2） money>131072  2^17后精度丢失 3*（8-2）-1=17
6、money float（8,3）money>16384  2^14 后精度丢失
7、money float（8,4）money>1024  2^10 后精度丢失

（3）定点型(精确)

浮点型由于内部的存储方式是数值，导致它在一定程度上取得的是近似值而非精确值。如果使用定点型，那么就可以精确取得小数部分，因为它内部存储方式是字符串形式。

定点型(精确)占用空间和取值范围

类型 字节 范围

DECIMAL/NUMERIC M+2 M最大65位，D最大30位。

创建一个定点型格式：DECIMAL(M,D)，表示小数点D位，整数部分M位及M位内。

### 1.2 列类型之日期

MySQL数据库中有五个可用的日期时间数据类型，分别为：DATE、DATETIME、TIME、YEAR、TIMESTAMP。

日期时间类型占用空间和取值范围

类型 字节 最小值 最大值

YEAR 1 1901 2155

TIME 3 -838:59:59 838:59:59

DATE 3 1000-01-01 9999-12-31

TIMESTAMP 4 1970-01-01 00:00:00 2038-01-19 03:14:07

DATETIME 8 1000-01-01 00:00:00 9999-12-31 23:59:59

TIMESTAMP有几个特点：

a.当更新一条数据的时候，设置此类型根据当前系统更新可自动更新时间；

b.如果插入一条NULL，也会自动插入当前系统时间；

c.创建字段时，系统会自动给一个默认值；

d.会根据当前时区来存储和查询时间，存储时对当前时区进行转换，查询时再转换为当前的时区。

### 1.3 列类型之字符串
字符串类型指CHAR、VARCHAR、BINARY、VARBINARY、BLOB、TEXT、ENUM和SET。该节描述了这些类型如何工作以及如何在查询中使用这些类型。

类型	       大小	                  用途
CHAR	    0-255 bytes	            定长字符串
VARCHAR	    0-65535 bytes	        变长字符串
TINYBLOB	0-255 bytes	            不超过 255 个字符的二进制字符串
TINYTEXT	0-255 bytes	            短文本字符串
BLOB	    0-65 535 bytes	        二进制形式的长文本数据
TEXT	    0-65 535 bytes	        长文本数据
MEDIUMBLOB	0-16 777 215 bytes	    二进制形式的中等长度文本数据
MEDIUMTEXT	0-16 777 215 bytes	    中等长度文本数据
LONGBLOB	0-4 294 967 295 bytes	二进制形式的极大文本数据
LONGTEXT	0-4 294 967 295 bytes	极大文本数据
注意：char(n) 和 varchar(n) 中括号中 n 代表字符的个数，并不代表字节个数，比如 CHAR(30) 就可以存储 30 个字符。

CHAR 和 VARCHAR 类型类似，但它们保存和检索的方式不同。它们的最大长度和是否尾部空格被保留等方面也不同。在存储或检索过程中不进行大小写转换。

BINARY 和 VARBINARY 类似于 CHAR 和 VARCHAR，不同的是它们包含二进制字符串而不要非二进制字符串。也就是说，它们包含字节字符串而不是字符字符串。这说明它们没有字符集，并且排序和比较基于列值字节的数值值。

BLOB 是一个二进制大对象，可以容纳可变数量的数据。有 4 种 BLOB 类型：TINYBLOB、BLOB、MEDIUMBLOB 和 LONGBLOB。它们区别在于可容纳存储范围不同。

有 4 种 TEXT 类型：TINYTEXT、TEXT、MEDIUMTEXT 和 LONGTEXT。对应的这 4 种 BLOB 类型，可存储的最大长度不同，可根据实际情况选择。

## 2 索引优化

### 2.1 何时需要建索引
（1）哪些情况下适合建立索引
主键自动建立唯一索引
频繁作为查询的条件的字段应该创建索引
查询中与其他表关联的字段，外键关系建立索引
单间/组合索引的选择问题，Who？（在高并发下倾向创建组合索引）
查询中排序的字段，排序字段若通过索引去访问将大大提高排序的速度
查询中分组字段
（2）哪些情况不要创建索引
表记录太少
经常增删改的表
数据重复且分布平均的表字段

全值匹配我最爱， 最左前缀要遵守；

带头大哥不能死， 中间兄弟不能断；

索引列上少计算， 范围之后全失效；

LIKE 百分写最右， 覆盖索引不写 *；

不等空值还有 OR， 索引影响要注意；

VAR 引号不可丢， SQL 优化有诀窍。

（3）Explain 详解

表的读取顺序（id 字段）
数据读取操作的操作类型（select_type 字段）
type：访问类型排列，显示查询使用了何种类型（system>const>eq_ref>ref>range>index>ALL）
哪些索引可以使用（possible_keys 字段）
哪些索引被实际使用（key 字段）
表之间的引用（ref 字段）
每张表有多少行被优化器查询（rows 字段）
Extra（Using filesort，Using temporary，Using index，Using where）
